version: "3.4"

services:
  main:
    build:
      context: ../..
      target: app_main
      dockerfile: ./installer/prod/Dockerfile
    restart: unless-stopped
    depends_on:
      - database
      - ollama
    volumes:
      - php_socket:/var/run/php
      - jwt:/srv/app/config/jwt
      - ${JWT_CERTS:-./docker/jwt}:/srv/app/config/jwt
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-dentest}:${POSTGRES_PASSWORD:-ChangeMe}@database:5432/${POSTGRES_DB:-dentest}?serverVersion=${POSTGRES_VERSION:-15}
      ALLOWED_ORIGIN: ${ALLOWED_ORIGIN:-https://dentest.tech}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE:-passphrase}
      MAILER_DSN: ${MAILER_DSN:-}
      FEATURE_SUMMARY_BASE_URL: ${FEATURE_SUMMARY_BASE_URL:-http://ollama:11434}
      FEATURE_SUMMARY_MODEL: ${FEATURE_SUMMARY_MODEL:-llama3.2:3b}
      FEATURE_SUMMARY_TIMEOUT: ${FEATURE_SUMMARY_TIMEOUT:-60}
      FEATURE_SUMMARY_STREAM_TIMEOUT: ${FEATURE_SUMMARY_STREAM_TIMEOUT:-300}
      FEATURE_SUMMARY_MAX_INPUT_CHARS: ${FEATURE_SUMMARY_MAX_INPUT_CHARS:-12000}
      FEATURE_SUMMARY_MAX_OUTPUT_CHARS: ${FEATURE_SUMMARY_MAX_OUTPUT_CHARS:-5000}
      FEATURE_SUMMARY_PROJECT_CONTEXT_MAX_CHARS: ${FEATURE_SUMMARY_PROJECT_CONTEXT_MAX_CHARS:-200000}
      FEATURE_SUMMARY_PROJECT_FEATURE_MAX_CHARS: ${FEATURE_SUMMARY_PROJECT_FEATURE_MAX_CHARS:-20000}
      FEATURE_SUMMARY_INCLUDE_PROJECT_CONTEXT: ${FEATURE_SUMMARY_INCLUDE_PROJECT_CONTEXT:-1}
      FEATURE_SUMMARY_NUM_CTX: ${FEATURE_SUMMARY_NUM_CTX:-16384}
      FEATURE_SUMMARY_TEMPERATURE: ${FEATURE_SUMMARY_TEMPERATURE:-0.2}
      FEATURE_SUMMARY_NUM_PREDICT: ${FEATURE_SUMMARY_NUM_PREDICT:-256}
    networks:
      - db
  caddy:
    build:
      context: ../..
      target: app_caddy
      dockerfile: ./installer/prod/Dockerfile
    depends_on:
      - main
    environment:
      SERVER_NAME: ${SERVER_NAME:-api.dentest.tech, caddy:80}
    restart: unless-stopped
    volumes:
      - php_socket:/var/run/php
      - caddy_data:/data
      - caddy_config:/config
      - ${IMAGES_VOLUME:-./public/images}:/srv/app/public/images
    ports:
      - target: 80
        published: ${HTTP_PORT:-80}
        protocol: tcp
  database:
    image: postgres:${POSTGRES_VERSION:-15}-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-dentest}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ChangeMe}
      POSTGRES_USER: ${POSTGRES_USER:-dentest}
    volumes:
      - db-data:/var/lib/postgresql/data:rw
      - ${POSTGRES_DATA:-./docker/db/data}:/var/lib/postgresql/data:rw
    user: root
    networks:
      - db
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    environment:
      OLLAMA_MODEL: ${FEATURE_SUMMARY_MODEL:-llama3.2:3b}
    volumes:
      - ollama-data:/root/.ollama
    command: >
      sh -c "ollama serve &
      sleep 2;
      if ! ollama list 2>/dev/null | awk 'NR>1 {print $1}' | grep -qx \"${OLLAMA_MODEL:-llama3.2:3b}\"; then
        ollama pull ${OLLAMA_MODEL:-llama3.2:3b};
      fi;
      wait"
    networks:
      - db
volumes:
  php_socket:
  caddy_data:
  caddy_config:
  db-data:
  jwt:
  ollama-data:

networks:
  db:
    driver: bridge
